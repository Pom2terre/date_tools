name: Deploy Flask to Azure using Azure CLI

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📅 Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📦 Install dependencies
        run: |
          pip install -r requirements.txt

      - name: 🗼 Create deployment package
        run: |
          mkdir deploy_folder
          shopt -s extglob
          cp -r !(deploy_folder|.git|.github|venv|__pycache__|deploy.zip) deploy_folder/
          cd deploy_folder
          zip -r ../deploy.zip .

      - name: 🔍 Inspect deploy.zip content
        run: unzip -l deploy.zip

      - name: 🔐 Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 🛠️ Set APP_VERSION env
        run: |
          VERSION=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | tail -n1)
          az webapp config appsettings set \
            --name my-python-app123 \
            --resource-group RESGrp_Linux \
            --settings APP_VERSION=$VERSION

      - name: 🚀 Deploy to Azure
        run: |
          echo "🕒 Pause avant déploiement pour stabiliser l'environnement"
          sleep 10
          az webapp deploy \
            --name my-python-app123 \
            --resource-group RESGrp_Linux \
            --src-path deploy.zip \
            --type zip
          echo "✅ Déploiement terminé avec succès !"