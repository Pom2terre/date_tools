name: Deploy Flask to Azure

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—œï¸ Create deployment package
        run: |
          echo "ğŸ“¦ Creating clean deploy.zip"
          zip -r deploy.zip * .[^.]* -x "deploy.zip" ".git/*" ".github/*" "venv/*" "**/__pycache__/*" "*.pyc" "*.pyo" "*.DS_Store"

      - name: ğŸš€ Deploy to Azure via zipdeploy
        env:
          ZIPDEPLOY_URL: https://${{ secrets.AZURE_APP_NAME }}.scm.azurewebsites.net/api/zipdeploy
        run: |
          echo "ğŸšš Uploading deploy.zip to $ZIPDEPLOY_URL"
          curl -X POST "$ZIPDEPLOY_URL" \
            -u ${{ secrets.AZURE_ZIPDEPLOY_USER }}:${{ secrets.AZURE_ZIPDEPLOY_PWD }} \
            --data-binary @"deploy.zip"
          echo "âœ… Deployment complete!"