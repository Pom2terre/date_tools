name: Deploy Flask to Azure using Azure CLI

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—œï¸ Create clean deployment package
        run: |
          mkdir deploy_folder
          shopt -s extglob
          cp -r !(deploy_folder|.git|.github|venv|__pycache__|deploy.zip) deploy_folder/
          cd deploy_folder
          zip -r ../deploy.zip .
          cd ..

      - name: ğŸ” Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸš€ Deploy to Azure Web App via CLI
        run: |
          az webapp deploy \
            --resource-group RESGrp_Linux \
            --name my-python-app123 \
            --src-path deploy.zip \
            --type zip
      
      - name: âœ… Test application endpoints (visuel + rÃ©sumÃ© + artefact)
        run: |
          echo "â³ Attente dÃ©marrage app..."
          sleep 15

          BASE_URL="https://my-python-app123.azurewebsites.net"

          PASSED=true
          SUMMARY="### ğŸ” RÃ©sumÃ© des tests de disponibilitÃ©\n"

          test_endpoint () {
            local path=$1
            local expect=$2
            local label=$3

            echo "ğŸ”¹ Test $label"
            if [ "$expect" == "content" ]; then
              if curl -fsSL "$BASE_URL$path" | grep -q "$label"; then
                echo "âœ… $label OK"
                SUMMARY+="âœ… \`$path\` contient '$label'\n"
              else
                echo "âŒ $label Ã‰chec (contenu manquant)"
                SUMMARY+="âŒ \`$path\` ne contient pas '$label'\n"
                PASSED=false
              fi
            else
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL$path")
              if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
                echo "âœ… $label ($STATUS)"
                SUMMARY+="âœ… \`$path\` a rÃ©pondu $STATUS\n"
              else
                echo "âŒ $label ($STATUS)"
                SUMMARY+="âŒ \`$path\` a Ã©chouÃ© avec $STATUS\n"
                PASSED=false
              fi
            fi
          }

          test_endpoint "/hello" "content" "Flask is running"
          test_endpoint "/" "status" "Page dâ€™accueil"
          test_endpoint "/calculate-duration" "status" "Calcul durÃ©e"
          test_endpoint "/day-of-week" "status" "Jour de la semaine"

          echo -e "$SUMMARY" > test-summary.md
          cat test-summary.md

          if [ "$PASSED" = false ]; then
            echo "âŒ Des tests ont Ã©chouÃ©."
            exit 1
          else
            echo "âœ… Tous les tests sont passÃ©s avec succÃ¨s."
          fi
        
      - name: ğŸ“¤ Publier le rÃ©sumÃ© des tests
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: test-summary.md


