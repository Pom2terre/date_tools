name: Deploy Flask to Azure using Azure CLI

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Installer GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—œï¸ Create clean deployment package
        run: |
          mkdir deploy_folder
          shopt -s extglob
          cp -r !(deploy_folder|.git|.github|venv|__pycache__|deploy.zip) deploy_folder/
          cd deploy_folder
          zip -r ../deploy.zip .
          cd ..

      - name: ğŸ·ï¸ GÃ©nÃ©rer un tag Git auto + release
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE_TAG=$(date +'%Y.%m.%d.%H%M')
          TAG="v$DATE_TAG"

          echo "CrÃ©ation du tag $TAG"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$TAG" -m "DÃ©ploiement automatique du $DATE_TAG"
          git push origin "$TAG"

          echo "CrÃ©ation de la release GitHub"
          gh auth setup-git
          gh release create "$TAG" --title "DÃ©ploiement $TAG" --notes "DÃ©ploiement automatique rÃ©alisÃ© via GitHub Actions le $DATE_TAG" || echo "Release dÃ©jÃ  existante"

      - name: ğŸ” Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸš€ Deploy to Azure Web App via CLI
        run: |
          az webapp deploy \
            --resource-group RESGrp_Linux \
            --name my-python-app123 \
            --src-path deploy.zip \
            --type zip

      - name: ğŸ†™ DÃ©finir APP_VERSION depuis le tag ou fallback
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)
          if [ -z "$TAG" ]; then
            TIMESTAMP=$(date +'%Y.%m.%d.%H%M')
            GIT_HASH=$(git rev-parse --short HEAD)
            TAG="${TIMESTAMP}-${GIT_HASH}"
          fi

          echo "Version Ã  utiliser : $TAG"
          az webapp config appsettings set \
            --name my-python-app123 \
            --resource-group RESGrp_Linux \
            --settings APP_VERSION=$TAG

      - name: âœ… Test application endpoints (visuel + rÃ©sumÃ© + artefact)
        run: |
          echo "â³ Attente dÃ©marrage app..."
          sleep 15

          BASE_URL="https://my-python-app123.azurewebsites.net"

          PASSED=true
          SUMMARY="### ğŸ” RÃ©sumÃ© des tests de disponibilitÃ©\n"

          test_endpoint () {
            local path=$1
            local expect=$2
            local label=$3

            echo "ğŸ”¹ Test $label"
            if [ "$expect" == "content" ]; then
              if curl -fsSL "$BASE_URL$path" | grep -q "$label"; then
                echo "âœ… $label OK"
                SUMMARY+="âœ… \`$path\` contient '$label'\n"
              else
                echo "âŒ $label Ã‰chec (contenu manquant)"
                SUMMARY+="âŒ \`$path\` ne contient pas '$label'\n"
                PASSED=false
              fi
            else
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL$path")
              if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
                echo "âœ… $label ($STATUS)"
                SUMMARY+="âœ… \`$path\` a rÃ©pondu $STATUS\n"
              else
                echo "âŒ $label ($STATUS)"
                SUMMARY+="âŒ \`$path\` a Ã©chouÃ© avec $STATUS\n"
                PASSED=false
              fi
            fi
          }

          test_endpoint "/hello" "content" "Flask is running"
          test_endpoint "/" "status" "Page dâ€™accueil"
          test_endpoint "/calculate-duration" "status" "Calcul durÃ©e"
          test_endpoint "/day-of-week" "status" "Jour de la semaine"

          echo -e "$SUMMARY" > test-summary.md
          cat test-summary.md

          if [ "$PASSED" = false ]; then
            echo "âŒ Des tests ont Ã©chouÃ©."
            exit 1
          else
            echo "âœ… Tous les tests sont passÃ©s avec succÃ¨s."
          fi

      - name: ğŸ“¤ Publier le rÃ©sumÃ© des tests
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: test-summary.md
