name: Deploy Flask to Azure using Azure CLI

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🗜️ Create clean deployment package
        run: |
          mkdir deploy_folder
          shopt -s extglob
          cp -r !(deploy_folder|.git|.github|venv|__pycache__|deploy.zip) deploy_folder/
          cd deploy_folder
          zip -r ../deploy.zip .
          cd ..

      - name: 🔐 Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 🚀 Deploy to Azure Web App via CLI
        run: |
          az webapp deploy \
            --resource-group RESGrp_Linux \
            --name my-python-app123 \
            --src-path deploy.zip \
            --type zip
      
      - name: ✅ Test application endpoints
        run: |
          echo "⏳ Attente démarrage app..."
          sleep 15

          BASE_URL="https://my-python-app123.azurewebsites.net"

          echo "🔎 Test /hello"
          curl -fsSL "$BASE_URL/hello" | grep "Flask is running"

          echo "🔎 Test / (HTTP/* 200)"
          curl -sLI "$BASE_URL/" | grep -E "HTTP/[0-9.]+ 200"

          echo "🔎 Test /calculate-duration (HTML page GET)"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/calculate-duration")
          if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
            echo "✅ /calculate-duration responded with $STATUS"
          else
            echo "❌ /calculate-duration failed with HTTP $STATUS"
            exit 1
          fi

          echo "🔎 Test /day-of-week"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/day-of-week")
          if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
            echo "✅ /day-of-week responded with $STATUS"
          else
            echo "❌ /day-of-week failed with HTTP $STATUS"
            exit 1
          fi

          echo "✅ Tous les tests de disponibilité sont passés !"

