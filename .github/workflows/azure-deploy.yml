name: Deploy Flask to Azure using Azure CLI

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Important pour rÃ©cupÃ©rer les tags

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r requirements.txt

          - name: ğŸ—œï¸ Create deployment package
          run: |
            mkdir deploy_folder
            rsync -av --exclude='venv/' --exclude='.git/' --exclude='.github/' --exclude='__pycache__/' . deploy_folder/
            cd deploy_folder && zip -r ../deploy.zip . && cd ..
        
      - name: ğŸ†™ Determine next version
        id: version
        run: |
          LATEST=$(git tag --sort=-v:refname | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | head -n1 || echo "v0.0.0")
          echo "Dernier tag : $LATEST"
          if [[ "$LATEST" =~ ^v?([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          else
            NEW_VERSION="v0.0.1"
          fi
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version calculÃ©e : $NEW_VERSION"

      - name: âœï¸ Mettre Ã  jour version.py
        run: |
          echo "APP_VERSION = \"${{ steps.version.outputs.NEW_VERSION }}\"" > version.py
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add version.py
          git commit -m "ğŸ”„ Mise Ã  jour version.py â†’ ${{ steps.version.outputs.NEW_VERSION }}"
          git fetch origin         # ğŸ‘ˆ Ajout important
          git push origin main
        

      - name: ğŸ·ï¸ Create new tag (if none in commit)
        run: |
          if [ -z "$(git tag --points-at HEAD)" ]; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git tag ${{ steps.version.outputs.NEW_VERSION }}
            git push origin ${{ steps.version.outputs.NEW_VERSION }}
          else
            echo "Tag dÃ©jÃ  existant pour ce commit."
          fi

      - name: ğŸ” Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ› ï¸ Update APP_VERSION on Azure
        run: |
          VERSION=$(git tag --points-at HEAD | tail -n1)
          az webapp config appsettings set \
            --name my-python-app123 \
            --resource-group RESGrp_Linux \
            --settings APP_VERSION=$VERSION

      - name: ğŸš€ Deploy to Azure
        run: |
          echo "ğŸ•’ Pause avant dÃ©ploiement pour stabiliser l'environnement"
          sleep 10
          az webapp deploy \
            --name my-python-app123 \
            --resource-group RESGrp_Linux \
            --src-path deploy.zip \
            --type zip

      - name: âœ… Test endpoints
        run: |
          sleep 15
          BASE="https://my-python-app123.azurewebsites.net"
          echo "### RÃ©sumÃ© des tests" > test-summary.md

          check() {
            echo "ğŸ”¹ $1" >> test-summary.md
            curl -fsSL "$BASE$2" > /dev/null \
              && echo "âœ… $2 OK" >> test-summary.md \
              || echo "âŒ $2 ECHEC" >> test-summary.md
          }

          check "Accueil" "/"
          check "Hello" "/hello"
          check "Jour" "/day-of-week"
          check "DurÃ©e" "/calculate-duration"

          cat test-summary.md

      - name: ğŸ“¤ Upload rÃ©sumÃ© des tests
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: test-summary.md
